/******/ (function(modules) { // webpackBootstrap
/******/ 	// The module cache
/******/ 	var installedModules = {};
/******/
/******/ 	// The require function
/******/ 	function __webpack_require__(moduleId) {
/******/
/******/ 		// Check if module is in cache
/******/ 		if(installedModules[moduleId]) {
/******/ 			return installedModules[moduleId].exports;
/******/ 		}
/******/ 		// Create a new module (and put it into the cache)
/******/ 		var module = installedModules[moduleId] = {
/******/ 			i: moduleId,
/******/ 			l: false,
/******/ 			exports: {}
/******/ 		};
/******/
/******/ 		// Execute the module function
/******/ 		modules[moduleId].call(module.exports, module, module.exports, __webpack_require__);
/******/
/******/ 		// Flag the module as loaded
/******/ 		module.l = true;
/******/
/******/ 		// Return the exports of the module
/******/ 		return module.exports;
/******/ 	}
/******/
/******/
/******/ 	// expose the modules object (__webpack_modules__)
/******/ 	__webpack_require__.m = modules;
/******/
/******/ 	// expose the module cache
/******/ 	__webpack_require__.c = installedModules;
/******/
/******/ 	// define getter function for harmony exports
/******/ 	__webpack_require__.d = function(exports, name, getter) {
/******/ 		if(!__webpack_require__.o(exports, name)) {
/******/ 			Object.defineProperty(exports, name, { enumerable: true, get: getter });
/******/ 		}
/******/ 	};
/******/
/******/ 	// define __esModule on exports
/******/ 	__webpack_require__.r = function(exports) {
/******/ 		if(typeof Symbol !== 'undefined' && Symbol.toStringTag) {
/******/ 			Object.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });
/******/ 		}
/******/ 		Object.defineProperty(exports, '__esModule', { value: true });
/******/ 	};
/******/
/******/ 	// create a fake namespace object
/******/ 	// mode & 1: value is a module id, require it
/******/ 	// mode & 2: merge all properties of value into the ns
/******/ 	// mode & 4: return value when already ns object
/******/ 	// mode & 8|1: behave like require
/******/ 	__webpack_require__.t = function(value, mode) {
/******/ 		if(mode & 1) value = __webpack_require__(value);
/******/ 		if(mode & 8) return value;
/******/ 		if((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;
/******/ 		var ns = Object.create(null);
/******/ 		__webpack_require__.r(ns);
/******/ 		Object.defineProperty(ns, 'default', { enumerable: true, value: value });
/******/ 		if(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));
/******/ 		return ns;
/******/ 	};
/******/
/******/ 	// getDefaultExport function for compatibility with non-harmony modules
/******/ 	__webpack_require__.n = function(module) {
/******/ 		var getter = module && module.__esModule ?
/******/ 			function getDefault() { return module['default']; } :
/******/ 			function getModuleExports() { return module; };
/******/ 		__webpack_require__.d(getter, 'a', getter);
/******/ 		return getter;
/******/ 	};
/******/
/******/ 	// Object.prototype.hasOwnProperty.call
/******/ 	__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };
/******/
/******/ 	// __webpack_public_path__
/******/ 	__webpack_require__.p = "";
/******/
/******/
/******/ 	// Load entry module and return exports
/******/ 	return __webpack_require__(__webpack_require__.s = "./dist/index.js");
/******/ })
/************************************************************************/
/******/ ({

/***/ "./dist/index.js":
/*!***********************!*\
  !*** ./dist/index.js ***!
  \***********************/
/*! no static exports found */
/***/ (function(module, exports, __webpack_require__) {

"use strict";
eval("\nvar __extends = (this && this.__extends) || (function () {\n    var extendStatics = function (d, b) {\n        extendStatics = Object.setPrototypeOf ||\n            ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||\n            function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };\n        return extendStatics(d, b);\n    };\n    return function (d, b) {\n        extendStatics(d, b);\n        function __() { this.constructor = d; }\n        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());\n    };\n})();\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nvar __generator = (this && this.__generator) || function (thisArg, body) {\n    var _ = { label: 0, sent: function() { if (t[0] & 1) throw t[1]; return t[1]; }, trys: [], ops: [] }, f, y, t, g;\n    return g = { next: verb(0), \"throw\": verb(1), \"return\": verb(2) }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function() { return this; }), g;\n    function verb(n) { return function (v) { return step([n, v]); }; }\n    function step(op) {\n        if (f) throw new TypeError(\"Generator is already executing.\");\n        while (_) try {\n            if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\n            if (y = 0, t) op = [op[0] & 2, t.value];\n            switch (op[0]) {\n                case 0: case 1: t = op; break;\n                case 4: _.label++; return { value: op[1], done: false };\n                case 5: _.label++; y = op[1]; op = [0]; continue;\n                case 7: op = _.ops.pop(); _.trys.pop(); continue;\n                default:\n                    if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) { _ = 0; continue; }\n                    if (op[0] === 3 && (!t || (op[1] > t[0] && op[1] < t[3]))) { _.label = op[1]; break; }\n                    if (op[0] === 6 && _.label < t[1]) { _.label = t[1]; t = op; break; }\n                    if (t && _.label < t[2]) { _.label = t[2]; _.ops.push(op); break; }\n                    if (t[2]) _.ops.pop();\n                    _.trys.pop(); continue;\n            }\n            op = body.call(thisArg, _);\n        } catch (e) { op = [6, e]; y = 0; } finally { f = t = 0; }\n        if (op[0] & 5) throw op[1]; return { value: op[0] ? op[1] : void 0, done: true };\n    }\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nvar JsonApiResponseError = /** @class */ (function (_super) {\n    __extends(JsonApiResponseError, _super);\n    function JsonApiResponseError(msg, jsonApiDoc) {\n        var _this = _super.call(this, msg) || this;\n        _this.jsonApiDoc = jsonApiDoc;\n        _this.code = \"JsonApiResponseError\";\n        return _this;\n    }\n    return JsonApiResponseError;\n}(Error));\nvar isJsonApiResponseError = function (e) {\n    return e.code && e.code === \"JsonApiResponseError\";\n};\nvar refreshToken = function (userId) {\n    return __awaiter(this, void 0, void 0, function () {\n        var response, text;\n        return __generator(this, function (_a) {\n            switch (_a.label) {\n                case 0: return [4 /*yield*/, fetch(\"http://localhost:3000/tokens/\" + userId)];\n                case 1:\n                    response = _a.sent();\n                    return [4 /*yield*/, response.text()];\n                case 2:\n                    text = _a.sent();\n                    if (!response.ok) {\n                        throw new Error(\"Couldn't fetch access token: \" + text);\n                    }\n                    return [2 /*return*/, text];\n            }\n        });\n    });\n};\nvar fetchWithToken = function (url, options) {\n    if (options === void 0) { options = {}; }\n    return __awaiter(this, void 0, void 0, function () {\n        var res;\n        return __generator(this, function (_a) {\n            if (!options) {\n                options = {};\n            }\n            if (!options.headers) {\n                options.headers = {};\n            }\n            if (!options.headers.Authorization) {\n                options.headers.Authorization = \"Bearer \" + token;\n            }\n            res = new Promise(function (resolve, reject) {\n                fetch(url, options)\n                    .then(function (res) {\n                    if (res.ok) {\n                        res.text().then(function (text) {\n                            if (text) {\n                                resolve(JSON.parse(text));\n                            }\n                            else {\n                                resolve(null);\n                            }\n                        });\n                    }\n                    else {\n                        if (res.status === 403) {\n                            refreshToken(1)\n                                .then(function (t) {\n                                token = t;\n                                fetch(url, options)\n                                    .then(function (res2) {\n                                    if (res2.ok) {\n                                        res2.text().then(function (text) {\n                                            if (text) {\n                                                resolve(JSON.parse(text));\n                                            }\n                                            else {\n                                                resolve(null);\n                                            }\n                                        });\n                                    }\n                                    else {\n                                        res2.text().then(function (text) {\n                                            reject(new JsonApiResponseError(\"Couldn't execute request. Received response code \" +\n                                                (res2.status + \" with body \" + text), JSON.parse(text)));\n                                        });\n                                    }\n                                });\n                            })\n                                .catch(function (e) {\n                                reject(e);\n                            });\n                        }\n                        else {\n                            res.text().then(function (text) {\n                                reject(new JsonApiResponseError(\"Couldn't execute request. Received response code \" +\n                                    (res.status + \" with body \" + text), JSON.parse(text)));\n                            });\n                        }\n                    }\n                });\n            });\n            return [2 /*return*/, res];\n        });\n    });\n};\nvar handleError = function (e) {\n    console.error(e);\n    var msg;\n    if (isJsonApiResponseError(e)) {\n        msg = \"There was an error getting users: \" + e.jsonApiDoc.errors\n            .map(function (e) { return e.title + \": \" + e.detail; })\n            .join(\"\\n\");\n    }\n    else {\n        msg = \"There was an error getting users: \" + e.message;\n    }\n    alert(msg);\n};\nvar getUsers = function (token) {\n    return __awaiter(this, void 0, void 0, function () {\n        var doc, e_1;\n        return __generator(this, function (_a) {\n            switch (_a.label) {\n                case 0:\n                    _a.trys.push([0, 2, , 3]);\n                    return [4 /*yield*/, fetchWithToken(\"http://localhost:3000/api/users\")];\n                case 1:\n                    doc = _a.sent();\n                    return [2 /*return*/, doc.data];\n                case 2:\n                    e_1 = _a.sent();\n                    handleError(e_1);\n                    return [2 /*return*/, []];\n                case 3: return [2 /*return*/];\n            }\n        });\n    });\n};\nvar buildUsersTable = function (users, container) {\n    // Reset content\n    container.innerHTML = '<div class=\"header cell1\">id</div>' +\n        '<div class=\"header cell2\">name</div><div class=\"header cell3\">email</div>' +\n        '<div class=\"header cell4\">TOS</div><div class=\"header cell5\">action</div>';\n    // Add rows\n    for (var i = 0; i < users.length; i++) {\n        var row = buildUserRow(users[i]);\n        for (var j = 0; j < row.length; j++) {\n            container.appendChild(row[j]);\n        }\n    }\n};\nvar buildUserRow = function (user) {\n    var _this = this;\n    var row = [];\n    var spec = [\n        [\"id\", String(user.id)],\n        [\"name\", user.attributes.name],\n        [\"email\", user.attributes.email],\n        [\"agreedTos\", \"<input type=\\\"checkbox\\\" \" + (user.attributes.agreedTos ? 'checked=\"checked\"' : \"\") + \" data-userId=\\\"\" + user.id + \"\\\">\"],\n        [\n            \"control\",\n            \"<button data-userId=\\\"\" + user.id + \"\\\">edit</button>\" +\n                (\"<button data-userId=\\\"\" + user.id + \"\\\">save</button>\") +\n                (\"<button data-userId=\\\"\" + user.id + \"\\\">delete</button>\")\n        ],\n        [\"log\", \"\"],\n    ];\n    for (var i = 0; i < spec.length; i++) {\n        var el = document.createElement(\"div\");\n        el.className = \"cell\" + (i + 1);\n        el.setAttribute(\"data-userId\", String(user.id));\n        el.id = \"users:\" + user.id + \"-\" + spec[i][0];\n        el.innerHTML = spec[i][1];\n        if (spec[i][0] === \"agreedTos\") {\n            el.getElementsByTagName(\"input\")[0].addEventListener(\"change\", function (ev) {\n                if (ev && ev.target) {\n                    toggleAgreement(ev.target.getAttribute(\"data-userId\"), ev.target.checked);\n                }\n            });\n        }\n        if (spec[i][0] === \"control\") {\n            var buttons = el.getElementsByTagName(\"button\");\n            buttons[0].addEventListener(\"click\", function (ev) { editUserRow(String(user.id)); });\n            buttons[1].addEventListener(\"click\", function (ev) { saveUserRow(String(user.id)); });\n            buttons[2].addEventListener(\"click\", function (ev) { deleteUserRow(String(user.id)); });\n            el.editButton = buttons[0];\n            el.saveButton = buttons[1];\n            el.deleteButton = buttons[2];\n            el.removeChild(buttons[1]);\n        }\n        new Promise(function (resolve, reject) { return __awaiter(_this, void 0, void 0, function () {\n            var history;\n            return __generator(this, function (_a) {\n                switch (_a.label) {\n                    case 0: return [4 /*yield*/, getObjectHistory(\"users\", user.id)];\n                    case 1:\n                        history = _a.sent();\n                        showObjectHistory(user.id, history);\n                        resolve();\n                        return [2 /*return*/];\n                }\n            });\n        }); });\n        row.push(el);\n    }\n    return row;\n};\nvar toggleAgreement = function (userId, agreed) {\n    return __awaiter(this, void 0, void 0, function () {\n        var e_2;\n        return __generator(this, function (_a) {\n            switch (_a.label) {\n                case 0:\n                    console.log(userId, agreed);\n                    _a.label = 1;\n                case 1:\n                    _a.trys.push([1, 3, , 4]);\n                    return [4 /*yield*/, fetchWithToken(\"http://localhost:3000/api/users/\" + userId, {\n                            method: \"PATCH\",\n                            headers: {\n                                \"Content-Type\": \"application/vnd.api+json\",\n                            },\n                            body: JSON.stringify({\n                                data: {\n                                    type: \"users\",\n                                    id: userId,\n                                    attributes: {\n                                        agreedTos: agreed ? 1 : 0\n                                    }\n                                }\n                            })\n                        })];\n                case 2:\n                    _a.sent();\n                    return [3 /*break*/, 4];\n                case 3:\n                    e_2 = _a.sent();\n                    handleError(e_2);\n                    return [3 /*break*/, 4];\n                case 4: return [2 /*return*/];\n            }\n        });\n    });\n};\nvar editUserRow = function (userId) {\n    console.log(\"Editing user row for user \" + userId);\n    var name = document.getElementById(\"users:\" + userId + \"-name\");\n    if (name) {\n        var nameInput = document.createElement(\"input\");\n        nameInput.type = \"text\";\n        nameInput.value = name.innerHTML;\n        name.innerHTML = \"\";\n        name.appendChild(nameInput);\n    }\n    var email = document.getElementById(\"users:\" + userId + \"-email\");\n    if (email) {\n        var emailInput = document.createElement(\"input\");\n        emailInput.type = \"email\";\n        emailInput.value = email.innerHTML;\n        email.innerHTML = \"\";\n        email.appendChild(emailInput);\n    }\n    var edit = document.getElementById(\"users:\" + userId + \"-control\");\n    if (edit) {\n        edit.removeChild(edit.editButton);\n        edit.removeChild(edit.deleteButton);\n        edit.appendChild(edit.saveButton);\n        edit.saveButton.disabled = false;\n    }\n};\nvar saveUserRow = function (userId) {\n    return __awaiter(this, void 0, void 0, function () {\n        var data, name, input, email, input, agreedTos, input, edit, body, url, doc, container, row, i, oldChild, e_3;\n        return __generator(this, function (_a) {\n            switch (_a.label) {\n                case 0:\n                    console.log(\"Saving user row for user \" + userId);\n                    data = {};\n                    name = document.getElementById(\"users:\" + userId + \"-name\");\n                    if (name) {\n                        input = name.getElementsByTagName(\"input\")[0];\n                        name.innerHTML = input.value;\n                        data.name = input.value;\n                    }\n                    email = document.getElementById(\"users:\" + userId + \"-email\");\n                    if (email) {\n                        input = email.getElementsByTagName(\"input\")[0];\n                        email.innerHTML = input.value;\n                        data.email = input.value;\n                    }\n                    agreedTos = document.getElementById(\"users:\" + userId + \"-agreedTos\");\n                    if (agreedTos) {\n                        input = agreedTos.getElementsByTagName(\"input\")[0];\n                        data.agreedTos = input.checked;\n                    }\n                    edit = document.getElementById(\"users:\" + userId + \"-control\");\n                    if (edit) {\n                        edit.saveButton.disabled = true;\n                    }\n                    _a.label = 1;\n                case 1:\n                    _a.trys.push([1, 3, , 4]);\n                    body = {\n                        data: {\n                            type: \"users\",\n                            attributes: data\n                        }\n                    };\n                    url = \"http://localhost:3000/api/users\";\n                    // If we're saving an existing user....\n                    if (userId != \"-1\") {\n                        url += \"/\" + userId;\n                        body.data.id = userId;\n                    }\n                    return [4 /*yield*/, fetchWithToken(url, {\n                            method: userId == \"-1\" ? \"POST\" : \"PATCH\",\n                            headers: {\n                                \"Content-Type\": \"application/vnd.api+json\"\n                            },\n                            body: JSON.stringify(body)\n                        })];\n                case 2:\n                    doc = _a.sent();\n                    if (edit && userId != \"-1\") {\n                        edit.appendChild(edit.editButton);\n                        edit.appendChild(edit.deleteButton);\n                        edit.removeChild(edit.saveButton);\n                        edit.deleteButton.disabled = false;\n                    }\n                    if (userId == \"-1\") {\n                        container = document.getElementById(\"users-list\");\n                        row = buildUserRow(doc.data);\n                        for (i = 0; i < row.length; i++) {\n                            oldChild = container.querySelector(\".cell\" + (i + 1) + \"[data-userId='\" + userId + \"']\");\n                            if (oldChild) {\n                                container.replaceChild(row[i], oldChild);\n                            }\n                            else {\n                                console.error(\"Couldn't locate old child \" + (\".cell\" + (i + 1) + \"[data-userId='\" + userId + \"']\"));\n                            }\n                        }\n                    }\n                    return [3 /*break*/, 4];\n                case 3:\n                    e_3 = _a.sent();\n                    edit.saveButton.disabled = false;\n                    handleError(e_3);\n                    return [3 /*break*/, 4];\n                case 4: return [2 /*return*/];\n            }\n        });\n    });\n};\nvar deleteUserRow = function (userId) {\n    return __awaiter(this, void 0, void 0, function () {\n        var edit, usersList, userCells, i, e_4;\n        return __generator(this, function (_a) {\n            switch (_a.label) {\n                case 0:\n                    if (userId == 1) {\n                        alert(\"You can't delete user 1. Try a different user.\");\n                        return [2 /*return*/];\n                    }\n                    console.log(\"Deleting user \" + userId);\n                    edit = document.getElementById(\"users:\" + userId + \"-control\");\n                    _a.label = 1;\n                case 1:\n                    _a.trys.push([1, 3, , 4]);\n                    edit.deleteButton.disabled = true;\n                    return [4 /*yield*/, fetchWithToken(\"http://localhost:3000/api/users/\" + userId, {\n                            method: \"DELETE\"\n                        })];\n                case 2:\n                    _a.sent();\n                    usersList = document.getElementById(\"users-list\");\n                    if (usersList) {\n                        userCells = usersList.querySelectorAll(\"[data-userId='\" + userId + \"']\");\n                        if (userCells) {\n                            for (i = 0; i < userCells.length; i++) {\n                                console.log(userCells[i].id);\n                                usersList.removeChild(userCells[i]);\n                            }\n                        }\n                    }\n                    return [3 /*break*/, 4];\n                case 3:\n                    e_4 = _a.sent();\n                    handleError(e_4);\n                    return [3 /*break*/, 4];\n                case 4:\n                    edit.deleteButton.disabled = false;\n                    return [2 /*return*/];\n            }\n        });\n    });\n};\nvar addUserRow = function () {\n    return __awaiter(this, void 0, void 0, function () {\n        var container, row, j;\n        return __generator(this, function (_a) {\n            container = document.getElementById(\"users-list\");\n            if (!container) {\n                alert(\"users-list not found!\");\n            }\n            else {\n                row = buildUserRow({\n                    type: \"users\",\n                    id: -1,\n                    attributes: {\n                        name: \"\",\n                        email: \"\",\n                        agreedTos: false,\n                    }\n                });\n                for (j = 0; j < row.length; j++) {\n                    container.appendChild(row[j]);\n                }\n                editUserRow(\"-1\");\n            }\n            return [2 /*return*/];\n        });\n    });\n};\nvar getObjectHistory = function (type, id) {\n    return __awaiter(this, void 0, void 0, function () {\n        var doc;\n        return __generator(this, function (_a) {\n            switch (_a.label) {\n                case 0: return [4 /*yield*/, fetchWithToken(\"http://localhost:3001/api/\" + type + \"/\" + id + \"/data-events\")];\n                case 1:\n                    doc = _a.sent();\n                    if (!doc) {\n                        throw new Error(\"Couldn't get data events for \" + type + \":\" + id);\n                    }\n                    return [2 /*return*/, doc.data];\n            }\n        });\n    });\n};\nvar showObjectHistory = function (userId, events) {\n    var container = document.getElementById(\"users:\" + userId + \"-log\");\n    if (!container) {\n        throw new Error(\"Couldn't find history container for user \" + userId);\n    }\n    container.innerHTML = \"\";\n    var ul = document.createElement(\"ul\");\n    for (var i = 0; i < events.length; i++) {\n        // Don't show instances of a user viewing himself\n        if (events[i].attributes.action === \"viewed\" &&\n            events[i].attributes.actorId === events[i].attributes.targetId &&\n            events[i].attributes.targetType === \"users\") {\n            continue;\n        }\n        var li = document.createElement(\"li\");\n        li.innerHTML = formatDataEvent(events[i]);\n        ul.appendChild(li);\n    }\n    container.appendChild(ul);\n};\nvar formatDataEvent = function (event) {\n    var e = event.attributes;\n    var t = new Date(e.timestamp);\n    if (e.action === \"changed\") {\n        return t.toLocaleString() + \": <strong>User \" + e.actorId + \" \" + e.action + \"</strong> the following \" +\n            \"fields:<ul>\" +\n            Object.keys(e.changes).map(function (k) { return \"<li>'\" + k + \"' from '\" + JSON.stringify(e.changes[k].prev) + \"' to '\" + JSON.stringify(e.changes[k].next) + \"'</li>\"; }).join(\"\\n\") +\n            \"</ul>\";\n    }\n    else {\n        return t.toLocaleString() + \": <strong>User \" + e.actorId + \" \" + e.action + \"</strong> this user\";\n    }\n};\nvar token = \"\";\nwindow.addEventListener(\"DOMContentLoaded\", function (ev) {\n    return __awaiter(this, void 0, void 0, function () {\n        var users, _a, addUserButton;\n        return __generator(this, function (_b) {\n            switch (_b.label) {\n                case 0: return [4 /*yield*/, refreshToken(1)];\n                case 1:\n                    token = _b.sent();\n                    users = getUsers(token);\n                    _a = buildUsersTable;\n                    return [4 /*yield*/, users];\n                case 2:\n                    _a.apply(void 0, [_b.sent(), document.getElementById(\"users-list\")]);\n                    addUserButton = document.getElementById(\"add-user\");\n                    if (addUserButton) {\n                        addUserButton.addEventListener(\"click\", addUserRow);\n                    }\n                    else {\n                        alert(\"No button with id 'add-user'!\");\n                    }\n                    return [2 /*return*/];\n            }\n        });\n    });\n});\n//# sourceMappingURL=index.js.map\n\n//# sourceURL=webpack:///./dist/index.js?");

/***/ })

/******/ });